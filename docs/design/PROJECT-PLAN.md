# 🔭 FlowSight 项目规划书

> **一个专为理解大型代码库设计的跨平台 IDE**
> 
> 让你看到代码的"灵魂"——执行流、异步调用、数据结构关系
> 
> 首要支持 Linux 内核，IDE 稳定后再扩展 Android 等其他平台

---

## 📋 目录

1. [项目愿景](#1-项目愿景)
2. [核心价值主张](#2-核心价值主张)
3. [技术架构设计](#3-技术架构设计)
4. [技术选型](#4-技术选型)
5. [详细开发计划](#5-详细开发计划)
6. [里程碑定义](#6-里程碑定义)
7. [项目结构](#7-项目结构)
8. [核心算法设计](#8-核心算法设计)
9. [UI/UX 设计](#9-uiux-设计)
   - [9.5 国际化 (i18n) 设计](#95-国际化-i18n-设计)
10. [风险评估与应对](#10-风险评估与应对)
11. [资源估算](#11-资源估算)
12. [成功指标](#12-成功指标)

---

## 🎯 核心开发策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         开发策略：先落地，再扩展                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   第一阶段：IDE 落地 (v1.0)                                              │
│   ══════════════════════════                                             │
│   • 知识库：只支持 Linux 内核                                            │
│   • 平台：Windows 优先 → Linux → macOS                                  │
│   • 语言：简体中文 + 英文 (首发双语支持)                                 │
│   • 目标：把 IDE 完整落地、调试稳定、发布正式版                          │
│                                                                          │
│   第二阶段：知识扩展 (v2.0+)                                             │
│   ══════════════════════════                                             │
│   • IDE 稳定后，逐步添加 Android 知识库                                  │
│   • 再逐步添加其他语言和平台                                             │
│   • 稳扎稳打，每步充分测试                                               │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  v0.1 → v0.5 → v1.0          v1.5 → v2.0          v2.5 → v3.0   │   │
│   │   │       │       │            │       │            │       │    │   │
│   │   └───────┴───────┘            └───────┘            └───────┘    │   │
│   │    Linux 内核 + IDE             Android              其他        │   │
│   │    ════════════════             ════════             ════        │   │
│   │     当前阶段重点                 下一阶段             远期        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 项目愿景

### 1.1 问题陈述

当开发者面对 Linux 内核这样的超大型代码库（2000万+ 行）时，现有工具存在严重不足：

| 现有工具 | 能做什么 | 做不到什么 |
|----------|----------|------------|
| VS Code + clangd | 符号跳转、补全 | 看不到异步执行流、函数指针指向 |
| Source Insight | 符号索引、调用图 | 不理解内核异步机制 |
| Understand | 静态分析、度量 | 无法追踪回调绑定 |
| Sourcetrail | 可视化调用图 | 已停止维护，不理解语义 |

**核心痛点**：当代码出现以下模式时，所有 IDE 都"迷路"了：

```c
// 😵 现有 IDE 看到这里就断了
INIT_WORK(&dev->work, my_handler);    // 绑定
schedule_work(&dev->work);             // 触发 → ??? 谁被调用？

request_irq(irq, irq_handler, ...);    // 注册 → ??? 何时执行？

static struct file_operations fops = {
    .read = my_read,                    // 赋值 → ??? 谁调用 .read？
};
```

### 1.2 解决方案

**FlowSight** —— 一个能"看懂"代码执行流的 IDE：

- 🔍 **静态分析** = 不需要运行代码，纯代码阅读
- 🧠 **语义理解** = 理解异步机制、回调模式、函数指针
- 📊 **可视化** = 看到完整的执行流程图
- ⏱️ **动态结合** = 允许导入运行时 Trace 数据进行验证
- 🖥️ **跨平台** = Windows (首要) / Linux / macOS

### 1.3 目标用户

| 用户群体 | 使用场景 |
|----------|----------|
| Linux 内核开发者 | 理解子系统、审查补丁 |
| 驱动开发者 | 学习驱动框架、调试问题 |
| **Android 系统开发者** | 理解 Framework、追踪 Binder 调用 |
| **Android App 开发者** | 分析复杂的回调和协程流程 |
| 安全研究员 | 漏洞分析、攻击面评估 |
| 嵌入式开发者 | 理解 BSP、定制内核 |
| 学生/教育者 | 学习操作系统原理 |

---

## 2. 核心价值主张

### 2.1 差异化功能

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      FlowSight 核心功能矩阵                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   功能                          VS Code    Source Insight   FlowSight       │
│   ─────────────────────────────────────────────────────────────────────────  │
│   基础代码编辑                    ✅           ✅              ✅            │
│   符号跳转 (LSP)                  ✅           ✅              ✅            │
│   函数调用图                      ⚠️           ✅              ✅ (交互式)   │
│   ─────────────────────────────────────────────────────────────────────────  │
│   异步执行流可视化                ❌           ❌              ✅ 核心       │
│   函数指针解析                    ❌           ⚠️              ✅ 核心       │
│   运行时 Trace 导入               ❌           ❌              ✅ 独有       │
│   Kconfig/DTS 解析                ❌           ❌              ✅ 独有       │
│   ─────────────────────────────────────────────────────────────────────────  │
│   内核框架知识库                  ❌           ❌              ✅            │
│   智能文档生成                    ❌           ❌              ✅            │
│   数据结构生命周期                ❌           ❌              ✅            │
│   ─────────────────────────────────────────────────────────────────────────  │
│   Android Binder 追踪             ❌           ❌              ✅ v2.0       │
│   JNI 跨语言分析                  ❌           ❌              ✅ v2.0       │
│   ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 用户故事

**故事1：理解 USB 热插拔流程**

> 作为内核开发者，我想看到当 USB 设备插入时，从 hub_irq() 中断到我的驱动 probe() 
> 被调用的完整流程，包括中间经过的工作队列、tasklet。我希望能在图上折叠掉我不关心的内核锁机制代码。

**故事2：追踪内存分配**

> 作为安全研究员，我想看到 kmalloc() 分配的内存在哪些函数中被使用，
> 最终在哪里被释放，并且我导入了一份 ftrace 日志，想在代码中高亮显示实际执行过的路径。

**故事3：编写新驱动**

> 作为驱动开发者，我写完了一个 I2C 驱动，想一键生成一份包含调用流程图和结构体关系图的 Markdown 文档，
> 以便向团队汇报。

---

## 3. 技术架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             FlowSight                                        │
│                              整体架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                           表现层 (Presentation)                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                      Tauri 桌面应用                              │   │ │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │   │ │
│  │  │  │  编辑器   │ │  项目    │ │  流程图   │ │  知识库   │       │   │ │
│  │  │  │  Monaco   │ │  管理器  │ │  D3/React │ │  编辑器   │       │   │ │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │   │ │
│  │  │                      React + TypeScript                         │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     │ Tauri IPC / Commands                   │
│                                     ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                           应用层 (Application)                          │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │   项目      │ │   查询     │ │   LSP     │ │   配置      │      │ │
│  │  │   服务      │ │   服务     │ │   客户端    │ │   管理      │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  │                           Rust (Tauri Backend)                         │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                           核心层 (Core)                                 │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐ │ │
│  │  │                       分析引擎 (flowsight-core)                         │ │ │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │ │ │
│  │  │  │ 解析器  │ │ 索引器  │ │ 类型    │ │ 调用图  │ │ 异步    │    │ │ │
│  │  │  │ Parser  │ │ Indexer │ │ System  │ │ Builder │ │ Tracker │    │ │ │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘    │ │ │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                │ │ │
│  │  │  │ 函数    │ │ Kconfig │ │ 知识库  │ │ Trace   │                │ │ │
│  │  │  │ 指针    │ │ /DTS    │ │ 引擎    │ │ Importer│                │ │ │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘                │ │ │
│  │  └───────────────────────────────────────────────────────────────────┘ │ │
│  │                              Rust                                       │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          基础层 (Infrastructure)                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │ tree-sitter │ │  LSP/Clang  │ │   SQLite    │ │   sled      │      │ │
│  │  │ (快速解析)  │ │ (精确语义)  │ │  (符号表)   │ │  (调用图)   │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 核心模块设计增强

#### 3.2.1 混合解析引擎 (Hybrid Parser)

*   **Tree-sitter**: 负责快速的语法高亮、大纲提取和初步的模式匹配。
*   **LSP 集成 (clangd)**: 负责精确的"跳转到定义"、"查找引用"、宏展开。我们不重复造轮子，而是利用成熟的 LSP 生态。
*   **Kconfig/DTS 解析**: 专门的模块解析内核配置文件 `.config` 和设备树 `.dts`，用于剔除未编译代码和关联硬件信息。

#### 3.2.2 动态 Trace 集成

*   **Importer**: 支持导入 `ftrace` (text/binary), `systrace`, `perf.data` 等格式。
*   **Mapper**: 将 Trace 中的函数地址/符号映射回源码位置。
*   **Visualizer**: 在静态调用图上叠加"热力图"或高亮路径，显示实际执行流。

#### 3.2.3 知识库编辑器

*   **GUI Editor**: 内置工具，允许用户通过 UI 操作创建新的匹配规则。
    *   例如：选中代码 -> 右键 "标记为异步触发点" -> 填写参数 -> 生成 YAML。

---

## 4. 技术选型

### 4.1 技术栈总览

| 层次 | 技术 | 理由 |
|------|------|------|
| **桌面框架** | Tauri 2.0 | 高性能、小体积、Rust 后端 |
| **前端框架** | React 18 + TS | 生态成熟、组件丰富 |
| **编辑器** | Monaco Editor | VS Code 同款，支持 Code Lens |
| **LSP 客户端** | monaco-languageclient | 标准协议支持 |
| **可视化** | React Flow / D3.js | 高度可定制的交互式图表 |
| **核心引擎** | Rust | 内存安全、高性能 |
| **解析** | tree-sitter + clangd | 速度与精度的平衡 |
| **存储** | SQLite + sled | 关系型与图数据的结合 |

---

## 5. 详细开发计划

### 5.1 总体时间线

```
2026                                    2027
Q1        Q2        Q3        Q4        Q1        Q2
│         │         │         │         │         │
▼         ▼         ▼         ▼         ▼         ▼
┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│  P0     │   P1    │   P2    │   P3    │   P4    │   P5    │
│ 原型    │  核心   │  IDE    │  完善   │  高级   │  生态   │
│ 验证    │  引擎   │  基础   │  优化   │  功能   │  建设   │
└─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
   MVP       Alpha     Beta    RC        v1.0      v1.x
```

### 5.2 Phase 0: 原型验证 (8 周)

**目标**: 验证核心技术可行性

*   [x] 项目仓库初始化
*   [x] Rust workspace 结构
*   [ ] tree-sitter-c 集成与 AST 遍历
*   [ ] 异步模式匹配原型 (work_struct)
*   [ ] 简单 UI 原型 (Tauri + React Flow)

### 5.3 Phase 1: 核心引擎增强 (12 周)

**目标**: 完成分析引擎核心功能，集成高级解析

*   **LSP 集成**: 实现与 `clangd` 的通信，获取精确符号信息。
*   **Kconfig 解析**: 读取 `.config` 文件，构建条件编译上下文。
*   **高级异步追踪**: 支持 timer, tasklet, irq 等 15+ 种模式。
*   **函数指针解析**: 实现基于 ops 表和变量赋值的解析算法。

### 5.4 Phase 2: IDE 交互体验 (12 周)

**目标**: 打造流畅的交互式 IDE

*   **交互式图谱**:
    *   [ ] 节点点击跳转代码
    *   [ ] **智能折叠**: 一键折叠不关心的子系统分支
    *   [ ] **聚类显示**: 自动聚合过于复杂的调用关系
*   **代码 "X光" (Code Lens)**:
    *   [ ] 在编辑器中直接显示 "被谁调用"、"触发异步任务" 的注解
*   **知识库 GUI**:
    *   [ ] 实现简单的规则编辑器，允许用户可视化添加规则

### 5.5 Phase 3: 完善与 Trace 集成 (12 周)

**目标**: 性能优化与动态分析支持

*   **Trace 导入**: 解析 ftrace 日志，映射到源码。
*   **热力图**: 在调用图上用颜色深浅表示调用频率。
*   **智能文档**: 一键导出当前分析视图为 Markdown/HTML 报告。

### 5.6 Phase 4: 高级功能与发布 (12 周)

**目标**: v1.0 正式版发布

*   **多平台打包**: Windows, Linux, macOS。
*   **国际化**: 完善中英文翻译。
*   **插件系统**: 初步支持用户脚本查询图数据库。

---

## 9. UI/UX 设计

### 9.1 交互式执行流视图

必须支持高度交互的操作，而不仅仅是静态图片：

*   **双击节点**: 跳转到对应源码行。
*   **右键菜单**: "折叠此分支"、"只看此路径"、"高亮相关数据流"。
*   **面包屑导航**: 在深入复杂调用链时，顶部显示当前路径。
*   **Mini Map**: 鸟瞰图，用于在巨大图谱中导航。

### 9.2 代码透视模式 (X-Ray Mode)

在编辑器行内显示增强信息：

```c
static int hub_probe(struct usb_interface *intf, ...)
{
    // [Code Lens] 2 callers | 1 async trigger
    
    struct usb_hub *hub;
    hub = kzalloc(sizeof(*hub), GFP_KERNEL);
    
    // [Code Lens] Binds to: hub_event()
    INIT_WORK(&hub->work, hub_event);
    
    // ...
}
```

### 9.3 智能文档生成

提供 "导出分析报告" 功能：

1.  用户选择一个入口函数（如 `probe`）。
2.  IDE 自动遍历其调用树。
3.  生成包含 SVG 流程图、函数说明、关键数据结构定义的 Markdown 文档。
4.  适用于技术评审、交接文档。

---

## 10. 风险评估与应对 (更新)

| 风险 | 可能性 | 影响 | 应对策略 |
|------|--------|------|----------|
| **LSP 集成复杂** | 中 | 中 | 使用成熟的 `monaco-languageclient` 库，不从零实现 |
| **图谱过于复杂** | 高 | 高 | **必须**实现智能折叠和聚类算法，默认只展开 2 层 |
| **Trace 数据量大** | 中 | 中 | 采用流式解析，只加载当前视图相关的时间段 |
| **Kconfig 解析繁琐** | 中 | 低 | 借用 Linux 内核自带的 `conf` 工具或现有 Python 库 |

---

## 11. 资源估算

*   **核心开发**: 2-3 人 (Rust/Tauri)
*   **前端交互**: 1-2 人 (React/D3/Canvas) - **交互式图谱需要重点投入**
*   **测试设备**: Windows 开发机 + Linux 编译服务器
